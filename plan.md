# ブラウン管テレビ表示モード実装計画

## 概要
X68000エミュレータにアナログブラウン管テレビの表示特性を再現する表示モードを追加する。1980年代のX68000が実際に接続されていたブラウン管テレビの視覚的特徴を忠実に再現し、ノスタルジックで本格的なレトロゲーム体験を提供する。

## 実装する視覚効果

### 1. スキャンライン効果 (Scanlines)
- **目的**: ブラウン管の水平走査線を再現
- **実装**: 画面全体に半透明の水平線を周期的に描画
- **パラメータ**:
  - スキャンライン強度: 0.1～0.8（可変）
  - スキャンライン間隔: 1～3ピクセル
  - 明暗比: 背景に対して10～30%の暗化

### 2. フォスファー/残光効果 (Phosphor Persistence)
- **目的**: ブラウン管蛍光体の残光現象を再現
- **実装**: 前フレームの画像を減衰させながら重ね合わせ
- **パラメータ**:
  - 残光強度: 0.1～0.6
  - 減衰率: フレームごとに85～95%
  - RGB各色で異なる減衰率（緑が最も持続）

### 3. ブルーミング効果 (Bloom/Glow)
- **目的**: 明るい部分の光のにじみを再現
- **実装**: 高輝度部分にガウシアンブラーを適用
- **パラメータ**:
  - ブルーム閾値: 0.6～0.9（輝度）
  - ブラー半径: 2～8ピクセル
  - ブルーム強度: 0.2～0.8

### 4. 色収差効果 (Chromatic Aberration)
- **目的**: レンズの色収差を再現
- **実装**: RGB各チャンネルを微妙にずらして合成
- **パラメータ**:
  - 赤色シフト: +0.5～+2.0ピクセル（画面端に向かって）
  - 青色シフト: -0.5～-2.0ピクセル
  - 効果強度: 0.1～0.5

### 5. 画面湾曲効果 (Screen Curvature)
- **目的**: ブラウン管画面の物理的湾曲を再現
- **実装**: バレル歪み変換を適用
- **パラメータ**:
  - 湾曲強度: 0.05～0.3
  - 画面端の丸め: 軽微なビネット効果

### 6. ノイズ効果 (TV Noise)
- **目的**: 電波受信ノイズとアナログ信号劣化を再現
- **実装**: ランダムノイズとアナログ信号歪みを追加
- **パラメータ**:
  - 静的ノイズ: 0.01～0.1強度
  - 動的ノイズ: フレームごとに変化
  - 信号歪み: 0.05～0.2強度

## 技術実装方針

### アーキテクチャ設計
```
GameScene.swift
├── 既存の表示パイプライン
├── CRTFilterManager (新規)
│   ├── CRTShaderEffects (Metal Shaders)
│   ├── CRTSettings (設定管理)
│   └── CRTPresets (プリセット管理)
└── 修正された updateSpriteWithTexture メソッド
```

### 1. CRTFilterManager クラス
- **責任**: ブラウン管効果全体の管理
- **機能**:
  - Metal シェーダーパイプラインの構築
  - 効果パラメータの管理
  - リアルタイム効果切り替え
  - パフォーマンス最適化

### 2. Metal Shader 実装
- **ファイル**: CRTShaders.metal
- **シェーダー**:
  - `crt_vertex_shader`: 頂点シェーダー（湾曲効果）
  - `crt_fragment_shader`: フラグメントシェーダー（各種エフェクト）
  - `scanline_shader`: スキャンライン専用
  - `phosphor_shader`: 残光効果専用

### 3. 設定管理システム
- **プリセット**:
  - オフ（現在の表示）
  - 軽微（subtle）: 控えめな効果
  - 標準（standard）: バランスの取れた効果
  - 強化（enhanced）: 強めの効果
  - カスタム: ユーザー設定可能

### 4. UI統合
- **場所**: ConfigScene.swift に新セクション追加
- **コントロール**:
  - 表示モード選択（プリセット）
  - 個別効果の強度スライダー
  - リアルタイムプレビュー

## 実装手順

### Phase 1: 基盤構築 (3-4日)
1. **CRTFilterManager クラス作成**
   - 基本的なMetal設定
   - シェーダーパイプライン構築
   - GameScene.swift との統合点準備

2. **基本 Metal Shader 実装**
   - 単純なスキャンライン効果から開始
   - テスト用の基本シェーダー作成

3. **GameScene.swift 修正**
   - updateSpriteWithTexture メソッドにフィルター適用フック追加
   - 既存レンダリングパイプラインとの統合

### Phase 2: 基本効果実装 (4-5日)
1. **スキャンライン効果**
   - Metal fragment shader 実装
   - 強度調整機能
   - パフォーマンス最適化

2. **ブルーミング効果**
   - 2-pass ブラー実装
   - 閾値ベースの明度検出
   - 合成処理

3. **基本テスト**
   - X68000 実行時の視覚確認
   - パフォーマンス測定

### Phase 3: 高度な効果 (5-6日)
1. **残光効果 (Phosphor Persistence)**
   - フレームバッファ管理
   - RGB別減衰率実装
   - メモリ使用量最適化

2. **色収差効果**
   - チャンネル分離処理
   - 画面位置依存のシフト計算

3. **画面湾曲効果**
   - 頂点シェーダー実装
   - UV座標変換
   - 歪み補正

### Phase 4: 設定・UI実装 (3-4日)
1. **設定システム**
   - CRTSettings クラス実装
   - UserDefaults 連携
   - プリセット管理

2. **UI統合**
   - ConfigScene.swift 拡張
   - リアルタイムプレビュー
   - スライダー・スイッチ配置

3. **プリセット作成**
   - 異なるブラウン管タイプの再現
   - ユーザビリティテスト

### Phase 5: 最適化・仕上げ (2-3日)
1. **パフォーマンス最適化**
   - GPU使用率測定
   - 不要な処理削除
   - メモリリーク確認

2. **品質保証**
   - 各プラットフォーム（iOS/macOS）での動作確認
   - 様々な解像度での表示確認
   - エッジケースの処理

## ファイル構成

### 新規追加ファイル
```
X68000 Shared/
├── CRT/
│   ├── CRTFilterManager.swift        # メイン管理クラス
│   ├── CRTSettings.swift            # 設定管理
│   ├── CRTShaders.metal             # Metal シェーダー
│   └── CRTPresets.swift             # プリセット定義
```

### 修正対象ファイル
```
X68000 Shared/
├── GameScene.swift                   # レンダリング統合
├── ConfigScene.swift                 # UI設定画面
└── 設定関連の既存ファイル
```

## パフォーマンス考慮事項

### 最適化方針
1. **GPU負荷分散**: 効果をパスごとに分割し、必要に応じて軽量化
2. **解像度適応**: デバイス性能に応じた効果強度自動調整
3. **キャッシュ活用**: 計算済みルックアップテーブルの使用
4. **条件分岐最小化**: シェーダー内の分岐を最小限に抑制

### 目標性能
- **iOS**: 60fps維持（iPhone 8以降）
- **macOS**: 60fps維持（統合GPU含む）
- **GPU使用率**: 追加で10～20%以内
- **メモリ使用量**: 追加で20MB以内

## プリセット定義

### 1. オフ (Off)
現在の表示モード（変更なし）

### 2. 軽微 (Subtle CRT)
- スキャンライン: 0.15強度
- ブルーミング: なし
- 残光: 0.1強度
- その他効果: 無効

### 3. 標準 (Standard CRT)
- スキャンライン: 0.3強度
- ブルーミング: 0.2強度
- 残光: 0.3強度
- 色収差: 0.15強度
- 軽微な画面湾曲: 0.1

### 4. 強化 (Enhanced CRT)
- スキャンライン: 0.5強度
- ブルーミング: 0.4強度
- 残光: 0.5強度
- 色収差: 0.3強度
- 画面湾曲: 0.2強度
- ノイズ: 0.05強度

### 5. カスタム (Custom)
ユーザーが個別に調整可能

## 期待される効果

### ユーザー体験向上
- **ノスタルジー**: 1980年代の実機体験の再現
- **没入感**: より本格的なレトロゲーム体験
- **選択肢**: 好みに応じた表示調整

### 技術的価値
- **差別化**: 他のエミュレータとの差別化要素
- **学習価値**: ブラウン管技術の教育的価値
- **技術展示**: Metal シェーダー技術の実用例

## 将来の拡張可能性

### 追加機能候補
1. **TV調整シミュレーション**: 明度・コントラスト・色相調整
2. **放送規格対応**: NTSC/PAL特有の効果
3. **複数ブラウン管タイプ**: メーカー・モデル別の特性再現
4. **アニメーション効果**: 電源投入時の点灯アニメーション
5. **デグラデーション**: 経年劣化シミュレーション

この計画により、X68000エミュレータに本格的なブラウン管テレビ表示モードが実装され、ユーザーに真正性の高いレトロゲーム体験を提供できます。
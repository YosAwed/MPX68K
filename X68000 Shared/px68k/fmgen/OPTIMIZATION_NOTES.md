# fmgen最適化に関する注意事項

## 音質問題の原因と修正

### 問題1: ブランチレス実装のマスク演算エラー

**原因:**
```cpp
// 間違った実装
ISample ch0_result = ch[0].Calc();
int mask0 = -(activech & 0x4000);
*idest[0] = (ch0_result & mask0) | (*idest[0] & ~mask0);
```

- ビット演算によるマスク処理が不正確
- 符号付き整数の右シフトによる符号拡張の問題
- チャンネル0の特別な代入処理（加算ではない）が正しく動作しない

**修正:**
```cpp
// 修正版
ISample ch0_result = ch[0].Calc();
if (activech & 0x4000) {
    *idest[0] = ch0_result;
}
```

### 問題2: NEON SIMD実装の型変換エラー

**原因:**
- `int32x4_t`の初期化構文が不正確
- ISample型とNEONベクトル型の型変換が不適切
- マスク演算の結果が期待と異なる

**修正:**
- SIMD実装を一時的に無効化
- 元のロジックを保持した安全な実装に変更

## 現在の最適化状況

### 有効な最適化（Level 1）
- ✅ チャンネル計算の先行実行
- ✅ 条件分岐の保持（音質優先）
- ✅ メモリアクセスパターンの改善

### 無効化した最適化
- ❌ ブランチレス実装（マスク演算版）
- ❌ SIMD実装（NEON/SSE）
- ❌ 複雑なビット演算による最適化

## 今後の改善方針

### 段階的な最適化
1. **音質確認**: 現在の実装で音質が正常であることを確認
2. **ベンチマーク**: 性能測定を実施
3. **慎重なSIMD実装**: より保守的なSIMD最適化を検討

### 推奨設定
```cpp
#define FMGEN_OPTIMIZATION_LEVEL 1  // 安全な最適化のみ
```

### テスト方法
1. 元の実装と最適化版の音質比較
2. 異なる楽曲での動作確認
3. 長時間再生でのメモリリーク確認

## 学んだ教訓

- 音響処理では数値精度が極めて重要
- ビット演算による最適化は慎重に行う必要がある
- SIMD最適化は段階的に導入すべき
- 常に元の動作との比較テストを実施する